<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">

<link rel="import" href="xtrm-page-behavior.html">
<!--
Page for confirming the email login
-->
<dom-module id="xtrm-login-confirmation">
  <template>
    <style>
      :host {
        display: flex;
      }
      .status {
        margin: auto;
        font-family: 'Roboto', sans-serif;
        font-size: 50px;
      }
    </style>
    <app-route
      route="{{route}}"
      pattern="/:token"
      data="{{data}}">
    </app-route>
    <div class="status">[[status]]</div>
  </template>
  <script>
    Polymer({
      is: 'xtrm-login-confirmation',

      behaviors: [XtrmPageBehavior],

      properties: {
        route: Object,
        data: {
          type: Object
        },
        status: {
          type: String,
          value: 'Trying to confirm login ...'
        }
      },

      observers: ['_dataChanged(data.*)'],

      _dataChanged: function() {
        if (!this.data || !this.data.token) return;
        var token = this.data.token;
        var request = new Request(API_CONFIRM_URL, {
          method: 'POST', 
          mode: 'cors', 
          redirect: 'follow',
          body: JSON.stringify({
            token: token
          })
        });
        var startingTime = new Date();
        fetch(request).then(result => {
          if (result.ok)
            return result.json();
        }).then(json => {
          var endingTime = new Date();
          var timeDiff = endingTime - startingTime;
          window.setTimeout(() => {
            if (json.success) {
              this.status = `Your log in ${json.browser} on ${json.os} was successful :)`;
            } else {
              this.status = json.error;
            }
          }, CONFIRM_TIMEOUT - timeDiff);
        });
      }
    });
  </script>
</dom-module>